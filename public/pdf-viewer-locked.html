<!doctype html>
<html lang="ku" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=no, viewport-fit=cover" />
  <title>PDF (Locked)</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/web/pdf_viewer.css">
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/web/pdf_viewer.js"></script>

  <style>
    :root { --bg:#0a0b0f; --fg:#f5f6f8; --ring:#1f2937; --card:#0e1117; --muted:#94a3b8; }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; overflow:hidden; }
    #viewer { position:fixed; inset:0; overflow:auto; overscroll-behavior:contain; height:100svh; -webkit-overflow-scrolling:touch; }
    .page { display:grid; place-items:center; width:100%; }
    .pageBox { position:relative; width:100%; background:var(--card); }
    canvas { display:block; width:100%; height:auto; }
    .textLayer { position:absolute; inset:0; color:transparent; user-select:text; pointer-events:auto; }
    .textLayer span, .textLayer br { color:transparent!important; }
    .textMode canvas { display:none; }
    .textMode .textLayer { color:#e5e7eb; font-family:"Noto Naskh Arabic","Noto Kufi Arabic",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }
    .textMode .textLayer span, .textMode .textLayer br { color:#e5e7eb!important; }
    .indicator { position:fixed; bottom:calc(10px + env(safe-area-inset-bottom)); inset-inline-end:calc(12px + env(safe-area-inset-right)); z-index:15; background:#0c1016cc; border:1px solid var(--ring); border-radius:.55rem; padding:.3rem .5rem; font-size:.72rem; color:var(--muted); backdrop-filter:blur(10px); }
    .loading { position:fixed; inset:0; display:grid; place-items:center; z-index:11; pointer-events:none; }
    .spinner { display:inline-flex; align-items:center; gap:.6rem; background:#0c1016cc; border:1px solid #ffffff18; border-radius:.7rem; padding:.6rem .8rem; font-size:.85rem; color:#e5e7eb; backdrop-filter:blur(8px); }
    .spin { width:20px; height:20px; border-radius:999px; border:3px solid #ffffff30; border-top-color:#34d399; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media print { body { display:none !important; } }
  </style>
</head>
<body oncontextmenu="return false">
  <div id="loading" class="loading" aria-hidden="true"><div class="spinner"><div class="spin"></div> بارکردن…</div></div>
  <main id="viewer" aria-label="PDF viewer"></main>
  <div id="indicator" class="indicator" style="display:none">پەڕە 1/1</div>

  <script>
    const qs         = new URLSearchParams(location.search);
    const resourceId = qs.get("id");
    const token      = qs.get("t") || "";
    const Z_PARAM    = qs.get("z");
    const preferText = qs.get("preferText") === "1";

    const PDF_BYTES_URL = (id) => `/api/v1/view/pdf/${encodeURIComponent(id)}`;

    const viewer    = document.getElementById("viewer");
    const loading   = document.getElementById("loading");
    const indicator = document.getElementById("indicator");

    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    const CMAP_URL      = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/";
    const STD_FONTS_URL = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/standard_fonts/";

    const DPR        = Math.min(window.devicePixelRatio || 1, 1.6);
    const BASE_SCALE = Number.isFinite(Number(Z_PARAM)) ? Math.max(0.1, Number(Z_PARAM)) : 0.6;

    let pdfDoc = null;
    let renderScale = BASE_SCALE;
    let pageOffsets = [];
    let rafTick = null;
    function post(msg){ try { window.parent.postMessage(msg, "*"); } catch(e){} }
    function hideLoading(){ loading.style.display = "none"; }

    async function fetchLockedPdfBytes() {
      const res = await fetch(PDF_BYTES_URL(resourceId), {
        method: "GET",
        headers: token ? { "Authorization": `Bearer ${token}` } : {},
        credentials: "include"
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const total = Number(res.headers.get("Content-Length")) || 0;
      const reader = res.body?.getReader?.();
      if (!reader) {
        const ab = await res.arrayBuffer();
        if (total) post({ type:"pdfviewer:progress", loaded: ab.byteLength, total, percent: 100 });
        return ab;
      }
      const chunks = []; let received = 0;
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value); received += value.length;
        if (total) {
          const p = Math.round(received/total*100);
          post({ type:"pdfviewer:progress", loaded: received, total, percent: p });
        }
      }
      const blob = new Blob(chunks, { type:"application/pdf" });
      post({ type:"pdfviewer:progress", loaded: blob.size, total, percent: 100 });
      return await blob.arrayBuffer();
    }

    function pageWrapper(){ const wrap=document.createElement("div"); wrap.className="page"; const box=document.createElement("div"); box.className="pageBox"; wrap.appendChild(box); return {wrap,box}; }
    function looksRTL(items){ let total=0,rtl=0; for(const it of items||[]) for(const ch of it.str||""){ const cp=ch.codePointAt(0); total++; if((cp>=0x0600&&cp<=0x06FF)||(cp>=0x0750&&cp<=0x077F)||(cp>=0x08A0&&cp<=0x08FF)||(cp>=0xFB50&&cp<=0xFDFF)||(cp>=0xFE70&&cp<=0xFEFF)) rtl++; } return total>0&&(rtl/total)>=0.3; }
    function updateIndicator(cur, total){ indicator.style.display="block"; indicator.textContent=`پەڕە ${cur}/${total}`; }
    function calcPageOffsets(){ const vr=viewer.getBoundingClientRect(); pageOffsets=Array.from(viewer.querySelectorAll(".page")).map(el=>{ const r=el.getBoundingClientRect(); return (r.top - vr.top) + viewer.scrollTop; }); }
    function currentPageFromScroll(){ if(!pageOffsets.length) return 1; const centerY=viewer.scrollTop+viewer.clientHeight*0.5; let lo=0,hi=pageOffsets.length-1,ans=0; while(lo<=hi){ const mid=(lo+hi)>>1; if(pageOffsets[mid]<=centerY){ ans=mid; lo=mid+1; } else hi=mid-1; } return ans+1; }
    function attachScrollHandler(total){ const onScroll=()=>{ if(rafTick) return; rafTick=requestAnimationFrame(()=>{ rafTick=null; updateIndicator(currentPageFromScroll(), total); }); }; viewer.addEventListener("scroll", onScroll, {passive:true}); onScroll(); }

    async function openPdf() {
      if (!resourceId) { viewer.innerHTML = '<div style="color:#fca5a5;text-align:center;padding:1rem">ناونیشانی بەڵگە نییە.</div>'; return; }
      let data; try { data = await fetchLockedPdfBytes(); } catch { viewer.innerHTML = '<div style="color:#fca5a5;text-align:center;padding:1rem">نەتوانرا PDF بار بکرێت.</div>'; hideLoading(); return; }
      const pdf = await pdfjsLib.getDocument({ data, cMapUrl: CMAP_URL, cMapPacked: true, standardFontDataUrl: STD_FONTS_URL, enableXfa: true }).promise;
      pdfDoc = pdf;

      const p1 = await pdf.getPage(1);
      const vp1 = p1.getViewport({ scale: 1 });
      renderScale = viewer.clientWidth / vp1.width;

      viewer.innerHTML = "";
      const frag = document.createDocumentFragment();
      for (let i=1;i<=pdf.numPages;i++){ const {wrap,box}=pageWrapper(); box.style.minHeight = Math.floor((vp1.height/vp1.width)*viewer.clientWidth) + "px"; wrap.dataset.index=i; frag.appendChild(wrap); }
      viewer.appendChild(frag);

      const io = new IntersectionObserver((entries) => {
        entries.forEach(async (entry) => {
          if (!entry.isIntersecting) return;
          const wrap = entry.target;
          const idx = Number(wrap.dataset.index);
          if (!idx || wrap.dataset.rendered === "1") return;
          wrap.dataset.rendered = "1";

          const box  = wrap.querySelector(".pageBox");
          const page = await pdf.getPage(idx);
          const vp   = page.getViewport({ scale: renderScale });

          const canvas = document.createElement("canvas");
          const ctx    = canvas.getContext("2d", { alpha:false });
          const ratio  = DPR;
          canvas.width  = Math.floor(vp.width * ratio);
          canvas.height = Math.floor(vp.height * ratio);
          canvas.style.width  = Math.floor(vp.width) + "px";
          canvas.style.height = Math.floor(vp.height) + "px";
          box.innerHTML = ""; box.appendChild(canvas);

          await page.render({ canvasContext: ctx, transform: [ratio,0,0,ratio,0,0], viewport: vp }).promise;

          const textLayerDiv = document.createElement("div");
          textLayerDiv.className = "textLayer"; box.appendChild(textLayerDiv);
          const textContent = await page.getTextContent({ includeMarkedContent: true });
          if (looksRTL(textContent.items)) textLayerDiv.dir = "rtl";
          const textLayer = pdfjsViewer.renderTextLayer({ textContent, container: textLayerDiv, viewport: vp, textDivs: [], enhanceTextSelection: true });
          await textLayer.promise;

          if (idx === 1) { hideLoading(); post({ type: "pdfviewer:ready" }); }
          calcPageOffsets();
        });
      }, { root: viewer, rootMargin: "600px 0px 900px 0px", threshold: 0.01 });

      viewer.querySelectorAll(".page").forEach(el => io.observe(el));
      calcPageOffsets(); attachScrollHandler(pdf.numPages);
      if (preferText) viewer.classList.add("textMode");
    }

    window.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && ["s","p","S","P"].includes(e.key)) { e.preventDefault(); e.stopPropagation(); }
    }, { passive:false });

    openPdf();
  </script>
</body>
</html>
